<!DOCTYPE html>
<html>
    <head>

      <meta charset='utf-8'>
      <title>Disease Simulation</title>

      <link rel='shortcut icon' href='https://specsonline.com/wp-content/uploads/2019/07/008066095695.jpg'>

    </head>
    <style>

        body {
            
            margin: 0px;
            overflow: hidden
            
        }

    </style>
    <body>

        <canvas id='me' >      
            Upgrade to a modern browser to view.     
        </canvas>

    </body>
    <script>

        //get canvas variables
        var c = document.getElementById('me').getContext("2d")
        c.canvas.width = window.innerWidth
        c.canvas.height = window.innerHeight
        var w = c.canvas.width
        var h = c.canvas.height
        var s = Math.min(w, h)
        
        //initialize global variables needed for simulation
        var infected = 0
        var trio = [0, 0, 0]
        var state = 1
        var states = 2
        
        var CreateParticles = function(number, particles, properties)//use this to create an array of particles
        {
            
            for ( var i = 0; i < number; i++ )
            {
                particles.push([Math.random(), Math.random(), 0, 0, ...properties])   
            }
            
        }
        
        var ReFrame = function(particles, Draw, Compare, Metrics, boost, speedboost, bubble)//call this every frame in the `refresh` function
        {
            
            for ( var i = 0; i < particles.length; i++ )
            {
                
                Draw(particles[i])
                Metrics(particles[i])
                
                particles[i][0] += boost * particles[i][2]
                particles[i][1] += boost * particles[i][3]
                
                particles[i][2] += 2 * speedboost * (Math.random() - 0.5)
                particles[i][3] += 2 * speedboost * (Math.random() - 0.5)
                
                for ( var j = 0; j < particles.length; j++ )
                {
                    
                    if ( i != j )
                    {
                        
                        if ( Math.sqrt(Math.pow(particles[i][0]-particles[j][0], 2)+Math.pow(particles[i][1]-particles[j][1], 2)) <= bubble )
                        {
                            particles[i][2] = -particles[i][2]
                            particles[i][3] = -particles[i][3]
                        }
                        
                    }
                   
                    Compare(particles[i], particles[j])
                    
                }
                
                if ( particles[i][0] < 0 ){
                    particles[i][0] = 0
                    particles[i][2] = -particles[i][2]
                }
                if ( particles[i][0] > 1 ){
                    particles[i][0] = 1
                    particles[i][2] = -particles[i][2]
                }
                if ( particles[i][1] < 0 ){
                    particles[i][1] = 0
                    particles[i][3] = -particles[i][3]
                }
                if ( particles[i][1] > 1 ){
                    particles[i][1] = 1
                    particles[i][3] = -particles[i][3]
                }
                
            }
                
        }
        
        
        var animate = function(particle)//use a custom animation function to draw particles
        {
            
            //sort particles by category
            if ( particle[4] == 0 )
            {
                //draw using particle x,y positions from the canvas
                c.fillStyle = '#27606b'
                c.beginPath()
                c.arc(w/2 - s * 3/8 + s * 3/4 * particle[0], h/2 - s * 3/8 + s * 3/4 * particle[1], 5, 0, 2*Math.PI)
                c.fill()
            }
            
            else if ( particle[4] == 1 )
            {
                
                c.fillStyle = '#f5644f'
                c.beginPath()
                c.arc(w/2 - s * 3/8 + s * 3/4 * particle[0], h/2 - s * 3/8 + s * 3/4 * particle[1], 5, 0, 2*Math.PI)
                c.fill()
                
                //post-processing
                var rand = Math.random()
                if ( rand <= r_rate/r_duration )
                {    
                    particle[4] = 2                  
                }
                
            }
            
            else if ( particle[4] == 2 )
            {
                c.fillStyle = '#3e3e3e'
                c.beginPath()
                c.arc(w/2 - s * 3/8 + s * 3/4 * particle[0], h/2 - s * 3/8 + s * 3/4 * particle[1], 5, 0, 2*Math.PI)
                c.fill()
            }
            
            //manipulate particles
            if ( state == 1 )
            {
                
                var rand = Math.random()
                if ( rand <= shop_rate/shop_duration )
                {
                    particle[0] = 0.5
                    particle[1] = 0.5
                }
            
            }
                
        }
        
        var infect = function(carrier, victim)//use a custom function for comparisons between particles
        {
            
            var rand = Math.random()//generate probabilistic models
            if ( carrier[4] == 1 && victim[4] == 0 && Math.sqrt(Math.pow(carrier[0] - victim[0], 2) + Math.pow(carrier[1] - victim[1], 2)) <= radius && rand <= i_rate/i_duration )//test a condition
            {
                
                victim[4] = 1
                victim[5] = true
                
            }
            
        }
        
        var getData = function(particle)//get custom metrics from particles to create visualizations (i.e graphs)
        {
            
            if ( particle[5] ){ infected++ }
            if ( particle[4] == 0 ){ trio[0]++ }
            if ( particle[4] == 1 ){ trio[1]++ }
            if ( particle[4] == 2 ){ trio[2]++ }
            
        }
        
        
        var people = []//create an empty array
        var people_cap = 250
        CreateParticles(people_cap, people, [0, false])//create required amount of particles
        //change a specific particle's properties
        people[0][4] = 1
        people[0][5] = true
    
        var radius = 0.05
        var i_rate = 0.1
        var i_duration = 30
        var r_rate = 0.07
        var r_duration = 30
        var f_rate = 0.2
        var data = []
        var trio_data = []
        var shop_rate = 0.05
        var shop_duration = 30
        
        var refresh = function()//refresh the display
        {
        
            //bounding box
            c.fillStyle = 'black'
            c.fillRect(0, 0, w, h)
            
            c.strokeStyle = 'white'
            c.strokeRect(w/2 - s * 3/8, h/2 - s * 3/8, s * 3/4, s * 3/4)
            
            //honestly though I would like a bit of the credit ...
            c.fillStyle = 'white'
            c.font = '24px Times'
            c.textAlign  = 'center'
            c.fillText('Inspired by 3b1b simulations.', w/2, h/2 + s * 3/8 - 55)
            c.font = '14px Times'
            c.fillText('Click to change simulation type.', w/2, h/2 + s * 3/8 - 36)
                        
            
            //initialize variables for the getData() function
            infected = 0
            trio = [0, 0, 0]
            
            ReFrame(people, animate, infect, getData, 0.025, 0.025, 0.01)//draw and change each frame
            
            //dump variables to an ongoing dataset
            data.push(infected/people_cap)
            trio_data.push(trio)
            
            
            //visualizations
            c.fillStyle = '#f5644f'
            if ( w > h ){
                
                for ( var i = 0; i < data.length; i++ )
                {
                    c.fillRect(w / 16 + (w * i) / (8 * data.length), h / 4, w / (8 * data.length), -data[i] * h/8)   
                }
            
            }
            else {
              
                for ( var i = 0; i < data.length; i++ )
                {
                    c.fillRect(w / 16 + (w * i) / (8 * data.length), h / 6, w / (8 * data.length), -data[i] * h/8)   
                }
                
            }
            c.font = '36px Times'
            c.textBaseline = 'top'
            c.textAlign = 'left'
            if ( w > h ){ c.fillText(Math.round(100*data[data.length - 1]) + '% Infected', w / 16, h / 4 + 20) }
            else { c.fillText(Math.round(100*data[data.length - 1]) + '% Infected', w / 16, h / 6 + 20) }
            
            if ( w > h ){
                
                for ( var i = 0; i < data.length; i++ )
                {
                    c.fillStyle = '#f5644f'
                    c.fillRect(w / 16 + (w * i) / (8 * trio_data.length),  h * 3/4, w / (8 * trio_data.length), -trio_data[i][1]/people_cap * h/8)
                    c.fillStyle = '#27606b'
                    c.fillRect(w / 16 + (w * i) / (8 * trio_data.length),  h * 3/4 - trio_data[i][1]/people_cap * h/8, w / (8 * trio_data.length), -trio_data[i][0]/people_cap * h/8)
                    c.fillStyle = '#3e3e3e'
                    c.fillRect(w / 16 + (w * i) / (8 * trio_data.length),  h * 3/4 - trio_data[i][0]/people_cap * h/8 - trio_data[i][1]/people_cap * h/8, w / (8 * trio_data.length), -trio_data[i][2]/people_cap * h/8)
                }
                
            }
            else {
                
                for ( var i = 0; i < data.length; i++ )
                {
                    c.fillStyle = '#f5644f'
                    c.fillRect(w / 16 + (w * i) / (8 * trio_data.length),  h * 7/8, w / (8 * trio_data.length), -trio_data[i][1]/people_cap * h/8)
                    c.fillStyle = '#27606b'
                    c.fillRect(w / 16 + (w * i) / (8 * trio_data.length),  h * 7/8 - trio_data[i][1]/people_cap * h/8, w / (8 * trio_data.length), -trio_data[i][0]/people_cap * h/8)
                    c.fillStyle = '#3e3e3e'
                    c.fillRect(w / 16 + (w * i) / (8 * trio_data.length),  h * 7/8 - trio_data[i][0]/people_cap * h/8 - trio_data[i][1]/people_cap * h/8, w / (8 * trio_data.length), -trio_data[i][2]/people_cap * h/8)
                }
                
            }
            c.fillStyle = '#27606b'
            c.font = '36px Times'
            c.textBaseline = 'top'
            c.textAlign = 'left'
            if ( w > h ){ c.fillText('Wheel Chart', w / 16, h * 3/4 + 20) }
            else { c.fillText('Wheel Chart', w / 16, h * 7/8 + 20) }
            
            c.fillStyle = '#3e3e3e'
            c.font = '72px Times'
            c.textBaseline = 'bottom'
            if ( w > h ){ c.fillText(Math.round(f_rate * people_cap * data[data.length - 1]) + ' Dead', w * 3/4, h / 4) }
            else { c.fillText(Math.round(f_rate * people_cap * data[data.length - 1]) + ' Dead', w * 2/3, h / 6) }
            c.font = '36px Times'
            if ( w > h ){ c.fillText('Fatalities', w * 3/4, h / 4 + 50) }
            else { c.fillText('Fatalities', w * 2/3, h / 6 + 50) }
            
            c.fillStyle = '#27606b'
            c.font = '72px Times'
            c.textBaseline = 'bottom'
            if ( w > h ){ c.fillText(trio_data[data.length - 1][0] + ' Left', w * 3/4, h * 3/4) }
            else { c.fillText(trio_data[data.length - 1][0] + ' Left', w * 2/3, h * 7/8) }
            c.font = '36px Times'
            if ( w > h ){ c.fillText('Uninfected', w * 3/4, h * 3/4 + 50) }
            else { c.fillText('Uninfected', w * 2/3, h * 7/8 + 50) }
            
            if ( state == 1 )
            {
                c.fillStyle = 'white'
                c.fillRect(w/2 - 7.5, h/2 - 7.5, 15, 15)
            }

            
            if ( data.length < 7000 )
            {
                window.requestAnimationFrame(refresh)//reanimate
            }
        
        }

        //scene management
        refresh()
        window.addEventListener("click", function(e){
            state++
            if ( state > states - 1 )
            {state = 0}
        })

    </script>
</html>
